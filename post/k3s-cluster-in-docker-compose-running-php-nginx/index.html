<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="referrer" content="never"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>K3s Cluster in Docker-Compose Running PHP Nginx | Blog | Snowme34</title><meta name="description" content="Run a K3s cluster in docker-compose with PHP + Nginx on 1 Gb, 1 vCPU server.If anything goes wrong: read documents; check if the versions match (things are changing every day)At the end of this page i"><meta property="og:type" content="article"><meta property="og:title" content="K3s Cluster in Docker-Compose Running PHP Nginx"><meta property="og:url" content="https://blog.snowme34.com/post/k3s-cluster-in-docker-compose-running-php-nginx/index.html"><meta property="og:site_name" content="Blog | Snowme34"><meta property="og:description" content="Run a K3s cluster in docker-compose with PHP + Nginx on 1 Gb, 1 vCPU server.If anything goes wrong: read documents; check if the versions match (things are changing every day)At the end of this page i"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2020-01-05T07:38:30.000Z"><meta property="article:modified_time" content="2020-01-07T04:56:03.127Z"><meta property="article:author" content="snowme34"><meta property="article:tag" content="Web-hosting"><meta property="article:tag" content="Tutorial"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Container"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@snowme34"><link rel="canonical" href="https://blog.snowme34.com/post/k3s-cluster-in-docker-compose-running-php-nginx/index.html"><link rel="alternate" href="/atom.xml" title="Blog | Snowme34" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 4.2.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/snowme34" target="_blank"><img class="img-circle img-rotate" src="https://www.gravatar.com/avatar/c98a78355e53db98057b4ff6ce70074b?s=128" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">snowme34</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Deveoloper</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> CA, US</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">Archives</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">Categories</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">Tags</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">Repository</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-profile"></i> <span class="menu-title">About</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/snowme34" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/snowme34" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.instagram.com/snowme34/" target="_blank" title="Instagram" data-toggle="tooltip" data-placement="top"><i class="icon icon-instagram"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">About this site</h3><div class="widget-body"><div id="board"><div class="content"><br>Check out <a style="color:#2196f3" href="https://docs.snowme34.com" target="_blank">snowme34's Docsnt</a> for non-blog articles (with more content)</div></div></div></div><div class="widget"><h3 class="widget-title">Categories</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Literature/">Literature</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Literature/Translations/">Translations</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Notes/">Notes</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Notes/Web-hosting/">Web-hosting</a><span class="category-list-count">1</span></li></ul></li></ul></div></div><div class="widget"><h3 class="widget-title">Tags</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Container/" rel="tag">Container</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Literature/" rel="tag">Literature</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Original/" rel="tag">Original</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shakespeare/" rel="tag">Shakespeare</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Trick/" rel="tag">Trick</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tutorial/" rel="tag">Tutorial</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web-hosting/" rel="tag">Web-hosting</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zh-CN/" rel="tag">zh-CN</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Tag Cloud</h3><div class="widget-body tagcloud"><a href="/tags/Container/" style="font-size:13px">Container</a> <a href="/tags/Kubernetes/" style="font-size:13px">Kubernetes</a> <a href="/tags/Literature/" style="font-size:13px">Literature</a> <a href="/tags/Original/" style="font-size:13px">Original</a> <a href="/tags/Shakespeare/" style="font-size:13px">Shakespeare</a> <a href="/tags/Trick/" style="font-size:13px">Trick</a> <a href="/tags/Tutorial/" style="font-size:14px">Tutorial</a> <a href="/tags/Web-hosting/" style="font-size:13px">Web-hosting</a> <a href="/tags/zh-CN/" style="font-size:13px">zh-CN</a></div></div><div class="widget"><h3 class="widget-title">Archive</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Notes/">Notes</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/Notes/Web-hosting/">Web-hosting</a></p><p class="item-title"><a href="/post/k3s-cluster-in-docker-compose-running-php-nginx/" class="title">K3s Cluster in Docker-Compose Running PHP Nginx</a></p><p class="item-date"><time datetime="2020-01-05T07:38:30.000Z" itemprop="datePublished">01/04/2020</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Notes/">Notes</a></p><p class="item-title"><a href="/post/schedule-tasks-using-crontab-on-windows-10-with-wsl/" class="title">Schedule Tasks Using Crontab on Windows 10 with WSL</a></p><p class="item-date"><time datetime="2018-09-26T00:36:10.000Z" itemprop="datePublished">09/25/2018</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Literature/">Literature</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/Literature/Translations/">Translations</a></p><p class="item-title"><a href="/post/Sonnet-18-zh-CN-translation/" class="title">Shakespeare Sonnet 18 Chinese Translation</a></p><p class="item-date"><time datetime="2018-03-22T06:49:40.000Z" itemprop="datePublished">03/21/2018</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">Catalogue</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Table-of-Content"><span class="toc-number">1.</span> <span class="toc-text">Table of Content</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Environment"><span class="toc-number">2.</span> <span class="toc-text">Environment</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prerequisites"><span class="toc-number">3.</span> <span class="toc-text">Prerequisites</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Set-Up-Directory"><span class="toc-number">4.</span> <span class="toc-text">Set Up Directory</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Launch-the-Cluster-using-Docker-Compose"><span class="toc-number">5.</span> <span class="toc-text">Launch the Cluster using Docker-Compose</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Talk-to-the-Cluster"><span class="toc-number">6.</span> <span class="toc-text">Talk to the Cluster</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Create-Cluster-Configs"><span class="toc-number">7.</span> <span class="toc-text">Create Cluster Configs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SSL-Key"><span class="toc-number">7.1.</span> <span class="toc-text">SSL Key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Snippets"><span class="toc-number">7.2.</span> <span class="toc-text">Nginx Snippets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Site"><span class="toc-number">7.3.</span> <span class="toc-text">Nginx Site</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-code"><span class="toc-number">7.4.</span> <span class="toc-text">PHP code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-Resources"><span class="toc-number">7.5.</span> <span class="toc-text">PHP Resources</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Resources"><span class="toc-number">7.6.</span> <span class="toc-text">Nginx Resources</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Config-and-Run-the-Cluster"><span class="toc-number">8.</span> <span class="toc-text">Config and Run the Cluster</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Result"><span class="toc-number">9.</span> <span class="toc-text">Result</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stop-and-Clean-up"><span class="toc-number">10.</span> <span class="toc-text">Stop and Clean up</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion-and-Thoughts"><span class="toc-number">11.</span> <span class="toc-text">Conclusion and Thoughts</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Future-Works"><span class="toc-number">12.</span> <span class="toc-text">Future Works</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">13.</span> <span class="toc-text">Reference</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-k3s-cluster-in-docker-compose-running-php-nginx" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">K3s Cluster in Docker-Compose Running PHP Nginx</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/post/k3s-cluster-in-docker-compose-running-php-nginx/" class="article-date"><time datetime="2020-01-05T07:38:30.000Z" itemprop="datePublished">01/04/2020</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/Notes/">Notes</a>/<a class="article-category-link" href="/categories/Notes/Web-hosting/">Web-hosting</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/Container/" rel="tag">Container</a>, <a class="article-tag-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a>, <a class="article-tag-link" href="/tags/Tutorial/" rel="tag">Tutorial</a>, <a class="article-tag-link" href="/tags/Web-hosting/" rel="tag">Web-hosting</a></span><span class="post-readcount hidden-xs" itemprop="timeRequired">Read Time: 14 minutes</span></div></div><div class="article-entry markdown-body" itemprop="articleBody"><p>Run a K3s cluster in docker-compose with PHP + Nginx on 1 Gb, 1 vCPU server.</p><p>If anything goes wrong: read documents; check if the versions match (things are changing every day)</p><p>At the end of this page includes a list of links used as reference when writing.</p><h1 id="Table-of-Content"><a href="#Table-of-Content" class="headerlink" title="Table of Content"></a>Table of Content</h1><ul><li><a href="#table-of-content">Table of Content</a></li><li><a href="#environment">Environment</a></li><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#set-up-directory">Set Up Directory</a></li><li><a href="#launch-the-cluster-using-docker-compose">Launch the Cluster using Docker-Compose</a></li><li><a href="#talk-to-the-cluster">Talk to the Cluster</a></li><li><a href="#create-cluster-configs">Create Cluster Configs</a><ul><li><a href="#ssl-key">SSL Key</a></li><li><a href="#nginx-snippets">Nginx Snippets</a></li><li><a href="#nginx-site">Nginx Site</a></li><li><a href="#php-code">PHP code</a></li><li><a href="#php-resources">PHP Resources</a></li><li><a href="#nginx-resources">Nginx Resources</a></li></ul></li><li><a href="#config-and-run-the-cluster">Config and Run the Cluster</a></li><li><a href="#result">Result</a></li><li><a href="#stop-and-clean-up">Stop and Clean up</a></li><li><a href="#conclusion-and-thoughts">Conclusion and Thoughts</a></li><li><a href="#future-works">Future Works</a></li><li><a href="#reference">Reference</a></li></ul><h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><ul><li>1 GB Memory</li><li>1 vCPU</li><li>25 GB SSD</li><li>Debian 10.2 on Digital Ocean Droplet</li></ul><h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul><li>docker</li><li>docker-compose</li><li>a domain if wish to use https (and certificates)</li></ul><p>Try this to set up but it’s more stable to use <code>iptables</code> at this moment (01/04/2020):</p><p><a href="https://docs.snowme34.com/en/latest/reference/devops/set-up-debian-10-server-on-digital-ocean.html" target="_blank" rel="noopener">Set Up Debian 10 Server on Digital Ocean</a></p><h1 id="Set-Up-Directory"><a href="#Set-Up-Directory" class="headerlink" title="Set Up Directory"></a>Set Up Directory</h1><p>Feel free to choose any work directory, but for the purpose of simplicity, a directory owned by a non-root user in the root directory (<code>/</code>) will be used for this task.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -v /docker/</span><br><span class="line"><span class="comment"># replace with your non-root user name and group</span></span><br><span class="line"><span class="comment"># (default group name is the same as the user name)</span></span><br><span class="line">sudo chown __NAME__:__GROUP__ /docker/</span><br></pre></td></tr></table></figure><p>To make it easier to manage and run scripts, create a <code>bin</code> directory</p><ul><li>here it is under <code>/docker/</code></li><li>alternatively, put it under <code>~/</code>, some distribution will automatically append it to <code>$PATH</code><ul><li>(<code>$PATH</code> is a list of directories that the shell will use to look for commands/executables)</li></ul></li><li>editing the <code>$PATH</code> variable is optional<ul><li>it makes calling the script the same as calling normal commands</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -v /docker/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># pre-pend it to PATH, making the search end earlier</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"PATH=/docker/bin:<span class="variable">$PATH</span>"</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><p>It doesn’t hurt to create several sub-directories for:</p><ul><li>Kubernetes resource yaml files</li><li>volumes to mount</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -v /docker/k3s</span><br><span class="line">mkdir -v /docker/kube</span><br><span class="line"></span><br><span class="line"><span class="comment"># this directory holds the PHP code, i.e. the index.php</span></span><br><span class="line"><span class="comment"># explained later</span></span><br><span class="line">mkdir -v /docker/www</span><br></pre></td></tr></table></figure><h1 id="Launch-the-Cluster-using-Docker-Compose"><a href="#Launch-the-Cluster-using-Docker-Compose" class="headerlink" title="Launch the Cluster using Docker-Compose"></a>Launch the Cluster using Docker-Compose</h1><p>As easy as one simple docker-compile file from <a href="https://github.com/rancher/k3s/blob/master/docker-compose.yml" target="_blank" rel="noopener">k3s official repo</a></p><p>Modifications:</p><ul><li>rename services</li><li>disable <code>traefik</code> by <code>--no-deploy traefik</code></li><li>mount directory with kubeconfig to host’s <code>./k3s</code> (created above)</li><li>mount php-code directory to container’s <code>/var/www</code></li><li>open 80 and 443 (http/https) port for agents</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># to run define K3S_TOKEN, K3S_VERSION is optional, eg:</span></span><br><span class="line"><span class="comment">#   K3S_TOKEN=$&#123;RANDOM&#125;$&#123;RANDOM&#125;$&#123;RANDOM&#125; docker-compose up</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">k3s-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"rancher/k3s:$&#123;K3S_VERSION:-latest&#125;"</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">--no-deploy</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">tmpfs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/run</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/run</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">K3S_TOKEN=$&#123;K3S_TOKEN:?err&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">K3S_KUBECONFIG_MODE=666</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k3s-server:/var/lib/rancher/k3s</span></span><br><span class="line">    <span class="comment"># This is just so that we get the kubeconfig file out</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./k3s:/output</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/docker/www:/var/www</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">6443</span><span class="string">:6443</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">k3s-agent:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"rancher/k3s:$&#123;K3S_VERSION:-latest&#125;"</span></span><br><span class="line">    <span class="attr">tmpfs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/run</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/run</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">K3S_URL=https://k3s-server:6443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">K3S_TOKEN=$&#123;K3S_TOKEN:?err&#125;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/docker/www:/var/www</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">k3s-server:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><p>Let’s create a script to run it:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /docker/bin/k3s-up</span><br><span class="line">chmod u+x /docker/bin/k3s-up</span><br></pre></td></tr></table></figure><p>Inside the up script:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># feel free to change this</span></span><br><span class="line"><span class="built_in">export</span> K3S_TOKEN=<span class="variable">$&#123;RANDOM&#125;</span><span class="variable">$&#123;RANDOM&#125;</span><span class="variable">$&#123;RANDOM&#125;</span><span class="variable">$&#123;RANDOM&#125;</span><span class="variable">$&#123;RANDOM&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"K3S_TOKEN: <span class="variable">$&#123;K3S_TOKEN&#125;</span>"</span></span><br><span class="line"><span class="comment"># might want to store token somewhere, e.g.</span></span><br><span class="line"><span class="comment">#echo $&#123;K3S_TOKEN&#125; &gt; ~/.token/K3S_TOKEN</span></span><br><span class="line"></span><br><span class="line">docker-compose -f /docker/docker-compose.yml up -d --scale k3s-agent=<span class="string">"<span class="variable">$&#123;1:-1&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>Now we just need to run this script</p><ul><li>since the directory is in <code>$PATH</code>, we can call it directly</li><li>it creates 1 agent by default, can change it by providing command line argument</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k3s-up    <span class="comment"># spawn 1 agents</span></span><br><span class="line"><span class="comment">#k3s-up 3 # spawn 3 agents</span></span><br></pre></td></tr></table></figure><p>Due to extreme memory constrain, let’s begin with 1 agent</p><h1 id="Talk-to-the-Cluster"><a href="#Talk-to-the-Cluster" class="headerlink" title="Talk to the Cluster"></a>Talk to the Cluster</h1><p>Now the k3s cluster is up and running.</p><p>The system might go through a short thrashing period but it will settle down soon (tested on real machine).</p><p>It’s time to <code>kubectl</code>. Let’s use the <code>$KUBECONFIG</code> variable to simplify things:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/docker/k3s/kubeconfig.yaml</span><br></pre></td></tr></table></figure><p>Might as well add this line to bashrc (optional):</p><ul><li>so that current user’s shell will automatically set KUBECONFIG variable</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"export KUBECONFIG=/docker/k3s/kubeconfig.yaml"</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure><p>Test connection</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure><p>If not working, consult <code>docker</code> and other logs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker logs</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="Create-Cluster-Configs"><a href="#Create-Cluster-Configs" class="headerlink" title="Create Cluster Configs"></a>Create Cluster Configs</h1><p>Attempts to use nginx ingress have been made in vain because of the limited resources.</p><p>We shall use our own nginx, plus <a href="https://rancher.com/docs/k3s/latest/en/networking/#service-load-balancer" target="_blank" rel="noopener">load balancer service provided by <code>k3s</code></a> (good to be simple for simple tasks).</p><p>Start with the config maps:</p><ul><li>note: provided nginx configs may not suit every one’s need</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /docker/kube/config-nginx-key      <span class="comment"># SSL key, if intend to use https</span></span><br><span class="line">mkdir /docker/kube/config-nginx-sites    <span class="comment"># nginx config for each site</span></span><br><span class="line">mkdir /docker/kube/config-nginx-snippets <span class="comment"># re-useable snippets</span></span><br></pre></td></tr></table></figure><p>Let’s go through each config file</p><ul><li><a href="https://www.digitalocean.com/community/tools/nginx" target="_blank" rel="noopener">main reference</a> for nginx config</li></ul><h2 id="SSL-Key"><a href="#SSL-Key" class="headerlink" title="SSL Key"></a>SSL Key</h2><p>(skip if using http)</p><p>Files in <code>/docker/kube/config-nginx-key</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSL certificates</span></span><br><span class="line">cert.pem</span><br><span class="line">cert.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># Diffie-Hellman parameters</span></span><br><span class="line"><span class="comment"># used by Nginx</span></span><br><span class="line"><span class="comment"># https://wiki.openssl.org/index.php/Diffie-Hellman_parameters</span></span><br><span class="line">dhparam.pem <span class="comment"># openssl dhparam -out ./dhparam.pem 4096</span></span><br></pre></td></tr></table></figure><p>For security reasons, my own SSL certificates will not be included here.</p><ul><li>Because I use Cloudflare, my cluster uses <a href="https://support.cloudflare.com/hc/en-us/articles/115000479507-Managing-Cloudflare-Origin-CA-certificates" target="_blank" rel="noopener">Cloudflare Origin CA certificates</a></li><li>Also it does not require complex verification, renewal steps etc.</li><li>If not suitable, might consider <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-with-cert-manager-on-digitalocean-kubernetes#step-4-%E2%80%94-installing-and-configuring-cert-manager" target="_blank" rel="noopener">a cert manager</a> (linked article uses ingress). That is beyond of the scope of this article</li></ul><h2 id="Nginx-Snippets"><a href="#Nginx-Snippets" class="headerlink" title="Nginx Snippets"></a>Nginx Snippets</h2><p>Files in <code>/docker/kube/config-nginx-snippets</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssl-some.host.conf</span><br><span class="line">ssl-params.conf</span><br><span class="line">security.conf</span><br></pre></td></tr></table></figure><p>ssl-some.host.conf</p><ul><li>just telling nginx which certificates to use</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_certificate     &#x2F;etc&#x2F;nginx&#x2F;ssl-key&#x2F;cert.pem;</span><br><span class="line">ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;ssl-key&#x2F;cert.key;</span><br></pre></td></tr></table></figure><p>ssl-params.conf</p><ul><li><a href="https://cipherli.st/" target="_blank" rel="noopener">cipherli.st</a></li><li><a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html" target="_blank" rel="noopener">String SSL Security On Nginx</a></li><li><a href="https://wiki.mozilla.org/Security/Server_Side_TLS" target="_blank" rel="noopener">Security/Server Side TLS - MozillaWiki</a></li><li>also if you are using Cloudflare like I do, end-users may see different headers etc.<ul><li>since clients are talking to Cloudflare, not the host machine directly in general cases</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># SSL</span><br><span class="line">ssl_session_timeout 1d;</span><br><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line"># Diffie-Hellman parameter for DHE ciphersuites</span><br><span class="line">ssl_dhparam &#x2F;etc&#x2F;nginx&#x2F;ssl-key&#x2F;dhparam.pem;</span><br><span class="line"></span><br><span class="line"># Mozilla Intermediate configuration</span><br><span class="line">ssl_protocols TLSv1.2 TLSv1.3;</span><br><span class="line">ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line"></span><br><span class="line"># OCSP Stapling</span><br><span class="line">ssl_stapling on;</span><br><span class="line">ssl_stapling_verify on;</span><br><span class="line">resolver 1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4 208.67.222.222 208.67.220.220 valid&#x3D;60s;</span><br><span class="line">resolver_timeout 2s;</span><br></pre></td></tr></table></figure><p>security.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># security headers</span><br><span class="line">add_header X-Frame-Options &quot;SAMEORIGIN&quot; always;</span><br><span class="line">add_header X-XSS-Protection &quot;1; mode&#x3D;block&quot; always;</span><br><span class="line">add_header X-Content-Type-Options &quot;nosniff&quot; always;</span><br><span class="line">add_header Referrer-Policy &quot;no-referrer-when-downgrade&quot; always;</span><br><span class="line">add_header Content-Security-Policy &quot;default-src &#39;self&#39; http: https: data: blob: &#39;unsafe-inline&#39;&quot; always;</span><br><span class="line">add_header Strict-Transport-Security &quot;max-age&#x3D;31536000; includeSubDomains; preload&quot; always;</span><br><span class="line"></span><br><span class="line"># . files</span><br><span class="line">location ~ &#x2F;\.(?!well-known) &#123;</span><br><span class="line">	deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## misc</span><br><span class="line">## not for security but included here for simplicity</span><br><span class="line"></span><br><span class="line"># favicon.ico</span><br><span class="line">location &#x3D; &#x2F;favicon.ico &#123;</span><br><span class="line">	log_not_found off;</span><br><span class="line">	access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># robots.txt</span><br><span class="line">location &#x3D; &#x2F;robots.txt &#123;</span><br><span class="line">	log_not_found off;</span><br><span class="line">	access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Nginx-Site"><a href="#Nginx-Site" class="headerlink" title="Nginx Site"></a>Nginx Site</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/docker/kube/config-nginx-sites/php.conf</span><br></pre></td></tr></table></figure><p>Heavily inspired by:</p><ul><li><a href="https://www.nginx.com/resources/wiki/start/topics/examples/phpfcgi/" target="_blank" rel="noopener">PHP FastCGI Example</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-a-php-application-with-kubernetes-on-ubuntu-18-04#step-5-%E2%80%94-creating-the-nginx-deployment" target="_blank" rel="noopener">How To Deploy a PHP Application with Kubernetes on Ubuntu 18.04 | DigitalOcean</a></li></ul><p>Choose one of the below:</p><ul><li>http</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  index index.php index.html;</span><br><span class="line">  root &#x2F;var&#x2F;www;</span><br><span class="line"></span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">      try_files $uri $uri&#x2F; &#x2F;index.php?$query_string;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location ~ \.php$ &#123;</span><br><span class="line">      try_files $uri &#x3D;404;</span><br><span class="line">      fastcgi_split_path_info ^(.+\.php)(&#x2F;.+)$;</span><br><span class="line">      fastcgi_pass kube-php:9000;</span><br><span class="line">      fastcgi_index index.php;</span><br><span class="line">      include fastcgi_params;</span><br><span class="line">      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">      fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>https</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  listen [::]:443 ssl http2;</span><br><span class="line"></span><br><span class="line">  include &#x2F;etc&#x2F;nginx&#x2F;snippets&#x2F;ssl-some.host.conf;</span><br><span class="line">  include &#x2F;etc&#x2F;nginx&#x2F;snippets&#x2F;ssl-params.conf;</span><br><span class="line"></span><br><span class="line">  root &#x2F;var&#x2F;www;</span><br><span class="line">  index  index.html  index.php;</span><br><span class="line"></span><br><span class="line">  ### change to your own host name ###</span><br><span class="line">  server_name some.host;</span><br><span class="line"></span><br><span class="line">  include &#x2F;etc&#x2F;nginx&#x2F;snippets&#x2F;security.conf;</span><br><span class="line"></span><br><span class="line">  location ~ [^&#x2F;]\.php(&#x2F;|$) &#123;</span><br><span class="line">    fastcgi_split_path_info ^(.+?\.php)(&#x2F;.*)$;</span><br><span class="line">    if (!-f $document_root$fastcgi_script_name) &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">    fastcgi_param HTTP_PROXY &quot;&quot;;</span><br><span class="line">    fastcgi_pass kube-php:9000;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME   $document_root$fastcgi_script_name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>Back to our kubernetes cluster, now we need to create:</p><ul><li>PHP code</li><li>PHP service</li><li>PHP deployment</li><li>nginx service LoadBalancer</li><li>nginx deployment</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -v /docker/kube/objects</span><br></pre></td></tr></table></figure><p>Will use one file for related resources</p><h2 id="PHP-code"><a href="#PHP-code" class="headerlink" title="PHP code"></a>PHP code</h2><p>For simplicity, the PHP code is directly put into <code>/docker/www</code></p><p>Sample PHP file, put to <code>/docker/www/index.php</code>:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> phpinfo();</span><br></pre></td></tr></table></figure><h2 id="PHP-Resources"><a href="#PHP-Resources" class="headerlink" title="PHP Resources"></a>PHP Resources</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">editor /docker/kube/objects/php.yaml</span><br></pre></td></tr></table></figure><p>Inside the yaml:</p><ul><li>it exposes port 9000 via ClusterIP (default networking for service) for php-fpm</li><li>php:7-fpm image is used</li><li>the php code directory mounted earlier, <code>/var/www</code>, is mounted as a <code>hostPath</code> volume<ul><li>generally <strong>not</strong> something desired in production</li><li>A possibly related <a href="https://stackoverflow.com/questions/46738296/multiple-kubernetes-pods-sharing-the-same-host-path-pvc-will-duplicate-output" target="_blank" rel="noopener">link</a> and <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/resources.md" target="_blank" rel="noopener">another</a>.</li><li>might consider a kubernetes init container to set up the code etc.</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-php</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kube-php</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-php</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kube-php</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kube-php</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">php:7-fpm</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/www</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/www</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure><h2 id="Nginx-Resources"><a href="#Nginx-Resources" class="headerlink" title="Nginx Resources"></a>Nginx Resources</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">editor /docker/kube/objects/nginx.yaml</span><br></pre></td></tr></table></figure><p>Inside the yaml:</p><ul><li>a LoadBalancer service is created with port 80 and 443<ul><li>thanks to k3s’s networking, normally a bare-mental kubernetes cannot use LoadBalancer services</li><li>(<a href="https://stackoverflow.com/questions/45079988/ingress-vs-load-balancer" target="_blank" rel="noopener">“LoadBalancer services … points to external load balancers that are NOT in your cluster”</a>)</li></ul></li><li>a deployment is created using nginx:1.16 image<ul><li>a naive and simple approach to test the config online is included</li><li>the config maps to be created are mounted as directories</li></ul></li><li>about nginx conf:<ul><li>nginx will automatically load conf in <code>/etc/nginx/conf.d</code></li><li>for our case, our php.conf will include all other config files</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kube-nginx</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kube-nginx</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kube-nginx</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.16</span></span><br><span class="line">        <span class="comment">## uncomment this to test the nginx config</span></span><br><span class="line">        <span class="comment">## use something like `kubectl logs kube-nginx-...` to see the output</span></span><br><span class="line">        <span class="comment">## use `kubectl delete deployment ...` to remove the test deployment</span></span><br><span class="line">        <span class="comment">#command: ["/bin/bash","-c"]</span></span><br><span class="line">        <span class="comment">#args: ["echo testing-nginx-conf; nginx -t; sleep 10h"]</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-key</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/nginx/ssl-key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-snippets</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/nginx/snippets</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-sites</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/www</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-key</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-nginx-key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-snippets</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-nginx-snippets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-sites</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-nginx-sites</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/www</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure><h1 id="Config-and-Run-the-Cluster"><a href="#Config-and-Run-the-Cluster" class="headerlink" title="Config and Run the Cluster"></a>Config and Run the Cluster</h1><p>Now we have both the configs and the Kubernetes resources files ready.</p><p>Just a short script will do all the setup</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /docker/bin/k3s-setup</span><br><span class="line">chmod u+x /docker/bin/k3s-setup</span><br></pre></td></tr></table></figure><p>Inside the setup script</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ensure the config works</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/docker/k3s/kubeconfig.yaml</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># test connection (optional)</span></span><br><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx config</span></span><br><span class="line">kubectl create configmap config-nginx-key      --from-file=/docker/kube/config_nginx-key</span><br><span class="line">kubectl create configmap config-nginx-snippets --from-file=/docker/kube/config_nginx-snippets</span><br><span class="line">kubectl create configmap config-nginx-sites    --from-file=/docker/kube/config_nginx-sites</span><br><span class="line"></span><br><span class="line"><span class="comment"># apply </span></span><br><span class="line">kubectl apply -f /docker/kube/objects</span><br></pre></td></tr></table></figure><p>Run the script</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k3s-setup</span><br></pre></td></tr></table></figure><h1 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h1><p>The whole server might suffer from a short period of thrashing after starting everything.</p><p>Assume all firewall, certificates and so forth all set up, go to <code>http://host-ip</code> or <code>https://some.host</code> (depend on your choice).</p><p>The PHP application will show up.</p><p>Each access to my host leads to around 40K <a href="https://en.wikipedia.org/wiki/Context_switch" target="_blank" rel="noopener">context switches</a>.</p><h1 id="Stop-and-Clean-up"><a href="#Stop-and-Clean-up" class="headerlink" title="Stop and Clean up"></a>Stop and Clean up</h1><p>If encounter errors in the previous steps, or need a graceful shutdown, here is a nothing-left-behind clean up script.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /docker/bin/k3s-down</span><br><span class="line">chmod u+x /docker/bin/k3s-down</span><br></pre></td></tr></table></figure><p>Inside the down script:</p><ul><li>shut down via docker-compose</li><li>remove the used master server volume</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the existence of this variable is required by the docker-compose file</span></span><br><span class="line"><span class="built_in">export</span> K3S_TOKEN=NOTHING</span><br><span class="line"><span class="comment"># if you want the original token, might consider storing it somewhere, e.g.</span></span><br><span class="line"><span class="comment">#export K3S_TOKEN=$(cat ~/.token/K3S_TOKEN)</span></span><br><span class="line"></span><br><span class="line">docker-compose -f /docker/docker-compose.yml down -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional, delete the no-longer-valid kubeconfig</span></span><br><span class="line">rm -f /docker/k3s/kubeconfig.yaml</span><br><span class="line"><span class="comment">#might remove the saved K3S_TOKEN as well</span></span><br></pre></td></tr></table></figure><h1 id="Conclusion-and-Thoughts"><a href="#Conclusion-and-Thoughts" class="headerlink" title="Conclusion and Thoughts"></a>Conclusion and Thoughts</h1><p>The purpose of Kubernetes is not, clearly, doing things like this.</p><p>But the k3s cluster created is perfect for dev and testing, especially for single-machine. And it’s fun to run a fully-functional Kubernetes on the cutest VPS!</p><h1 id="Future-Works"><a href="#Future-Works" class="headerlink" title="Future Works"></a>Future Works</h1><ul><li>make the cluster persistent<ul><li>currently cleaning everything up</li><li>might use <code>docker-compose stop</code>, but ideally only the master data is needed</li><li>potentially related: <a href="https://github.com/rancher/k3s/issues/927" target="_blank" rel="noopener">How to make a full backup of k3s server’s data? · Issue #927 · rancher/k3s</a></li></ul></li><li>use secrets</li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>Some of documents/tutorials are not updated or no longer working.</p><p>Tutorials</p><ul><li><a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-a-php-application-with-kubernetes-on-ubuntu-18-04" target="_blank" rel="noopener">How To Deploy a PHP Application with Kubernetes on Ubuntu 18.04 | DigitalOcean</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-with-cert-manager-on-digitalocean-kubernetes" target="_blank" rel="noopener">How to Set Up an Nginx Ingress with Cert-Manager on DigitalOcean Kubernetes | DigitalOcean</a></li><li><a href="https://qiita.com/Tei1988/items/0ef7dfba11497696bf56" target="_blank" rel="noopener">docker-composeでK3sを試してみた - Qiita</a></li><li><a href="https://www.redpill-linpro.com/techblog/2019/04/04/kubernetes-setup.html" target="_blank" rel="noopener">Single node Kubernetes setup – /techblog</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-kubernetes-cluster-using-kubeadm-on-ubuntu-18-04" target="_blank" rel="noopener">How To Create a Kubernetes Cluster Using Kubeadm on Ubuntu 18.04 | DigitalOcean</a></li></ul><p>K3s</p><ul><li><a href="https://rancher.com/docs/k3s/latest/en/installation/install-options/" target="_blank" rel="noopener">Installation Options</a></li><li><a href="https://rancher.com/docs/k3s/latest/en/networking/" target="_blank" rel="noopener">Networking</a></li><li><a href="https://rancher.com/docs/k3s/latest/en/advanced/" target="_blank" rel="noopener">Advanced Options and Configuration</a></li><li><a href="https://rancher.com/docs/k3s/latest/en/storage/" target="_blank" rel="noopener">Volumes and Storage</a></li><li><a href="https://github.com/rancher/local-path-provisioner/blob/master/README.md#usage" target="_blank" rel="noopener">local-path-provisioner/README.md at master · rancher/local-path-provisioner</a></li></ul><p>Kubernetes</p><ul><li><a href="https://www.reddit.com/r/kubernetes/comments/be0415/k3s_minikube_or_microk8s/" target="_blank" rel="noopener">K3s, minikube or microk8s? : kubernetes</a></li><li><a href="https://kubectl.docs.kubernetes.io/pages/kubectl_book/resources_and_controllers.html" target="_blank" rel="noopener">Resources + Controllers Overview · The Kubectl Book</a></li><li><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-pod-replication-controller/" target="_blank" rel="noopener">Debug Pod Replication Controller - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" target="_blank" rel="noopener">Creating a single control-plane cluster with kubeadm - Kubernetes</a></li></ul><p>Kubernetes Volumes</p><ul><li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath" target="_blank" rel="noopener">Volumes - Kubernetes</a> hostPath</li><li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#add-configmap-data-to-a-volume" target="_blank" rel="noopener">Configure a Pod to Use a ConfigMap - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#claims-as-volumes" target="_blank" rel="noopener">Persistent Volumes - Kubernetes</a></li><li><a href="https://kubernetes.io/blog/2019/04/04/kubernetes-1.14-local-persistent-volumes-ga/" target="_blank" rel="noopener">Kubernetes 1.14: Local Persistent Volumes GA - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#local" target="_blank" rel="noopener">Storage Classes - Kubernetes</a> local</li><li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/resources.md" target="_blank" rel="noopener">community/resources.md at master · kubernetes/community</a></li></ul><p>Kubernetes Networking</p><ul><li><a href="https://stackoverflow.com/questions/45079988/ingress-vs-load-balancer" target="_blank" rel="noopener">Ingress vs Load Balancer</a></li><li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#alternatives" target="_blank" rel="noopener">Ingress - Kubernetes</a></li><li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/" target="_blank" rel="noopener">Bare-metal considerations - NGINX Ingress Controller</a></li><li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/fcgi-services/" target="_blank" rel="noopener">Exposing FCGI services - NGINX Ingress Controller</a></li><li><a href="https://stackoverflow.com/questions/52041010/nginx-php-fpm-multiple-application-k8s-ingress" target="_blank" rel="noopener">symfony - NGINX - PHP-FPM multiple application K8s/Ingress - Stack Overflow</a></li><li><a href="https://github.com/kubernetes/ingress-nginx/tree/master/docs/examples/multi-tls" target="_blank" rel="noopener">ingress-nginx/docs/examples/multi-tls at master · kubernetes/ingress-nginx</a></li></ul><p>Nginx config</p><ul><li><a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html" target="_blank" rel="noopener">Strong SSL Security on nginx - Raymii.org</a></li><li><a href="https://github.com/h5bp/server-configs-nginx" target="_blank" rel="noopener">h5bp/server-configs-nginx: Nginx HTTP server boilerplate configs</a></li><li><a href="https://github.com/h5bp/server-configs-nginx/pull/190#issuecomment-367843852" target="_blank" rel="noopener">Remove deprecated ciphers and protocols by aeris · Pull Request #190 · h5bp/server-configs-nginx</a></li><li><a href="https://github.com/roots/trellis/pull/1127" target="_blank" rel="noopener">Use modern SSL config for Nginx by swalkinshaw · Pull Request #1127 · roots/trellis</a></li><li><a href="https://wiki.mozilla.org/Security/Server_Side_TLS" target="_blank" rel="noopener">Security/Server Side TLS - MozillaWiki</a></li><li><a href="https://cryptcheck.fr/suite/" target="_blank" rel="noopener">CryptCheck</a></li></ul></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>Link: </strong><a href="https://blog.snowme34.com/post/k3s-cluster-in-docker-compose-running-php-nginx/" title="K3s Cluster in Docker-Compose Running PHP Nginx" target="_blank" rel="external">https://blog.snowme34.com/post/k3s-cluster-in-docker-compose-running-php-nginx/</a></li><li class="post-copyright-license"><strong>Copyright: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external">CC BY-NC-SA 4.0</a> unless stating additionally.</li></ul></blockquote></div></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript></div></section></div><nav class="bar bar-footer clearfix"><div class="bar-inner"><ul class="pager pull-left"><li class="next"><a href="/post/schedule-tasks-using-crontab-on-windows-10-with-wsl/" title="Schedule Tasks Using Crontab on Windows 10 with WSL"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"><div class="share-component" data-sites="facebook,twitter,google,linkedin,tencent,weibo,qq,qzone,wechat" data-mobile-sites="facebook,twitter,google,linkedin,tencent,weibo,qq,qzone,wechat"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/snowme34" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/snowme34" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.instagram.com/snowme34/" target="_blank" title="Instagram" data-toggle="tooltip" data-placement="top"><i class="icon icon-instagram"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><p>Proudly using <a href="https://hexo.io/" target="_blank" rel="noopener" style="font-weight:700">Hexo</a> | <a href="https://github.com/snowme34/hexo-theme-symphony" target="_blank" rel="noopener" style="font-weight:700">Symphony</a></p>&copy; 2023 snowme34 <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script defer>var disqus_config=function(){this.page.url="https://blog.snowme34.com/post/k3s-cluster-in-docker-compose-running-php-nginx/",this.page.identifier="k3s-cluster-in-docker-compose-running-php-nginx"};!function(){var e=document,n=e.createElement("script");n.src="//blog-snowme34.disqus.com/embed.js",n.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(n)}()</script></body></html>